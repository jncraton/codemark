<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title></title>
    <style>
      textarea {
        width: 80ch;
        height: 20em;
      }
      section {
        display: inline-block;
      }
      section.wholerow {
        display: block;
      }
      section > label {
        display: block;
      }
    </style>
  </head>

  <body>
    <label><input id="spaces" type="checkbox" checked />Tabs to Spaces</label>
    <label><input id="whitespace" type="checkbox" checked />Vary Spaces</label>
    <label><input id="strings" type="checkbox" />Corrupt Strings</label>
    <label><input id="bold" type="checkbox" />Bold keywords</label>
    <label><input id="linenums" type="checkbox" />Line Numbers</label>

    <section class="wholerow">
      <label for="src">Input</label>
      <textarea id="src"></textarea>
    </section>

    <section style="display: inline-block">
      <label for="watermarked">Watermarked</label>
      <textarea id="watermarked"></textarea>
    </section>

    <section style="display: inline-block">
      <label for="repaired">Repaired</label>
      <textarea id="repaired"></textarea>
    </section>

    <script>
      const keywords = [
        'const',
        'let',
        'int',
        'float',
        'void',
        'function',
        'return',
        'def',
        'if',
        'elif',
        'else',
        'import',
        'try',
        'except',
        'catch',
      ]
      const letters = 'abcdefghijklmnopqrstuvwxyz'
      const bold_letters = [
        'ðš',
        'ð›',
        'ðœ',
        'ð',
        'ðž',
        'ðŸ',
        'ð ',
        'ð¡',
        'ð¢',
        'ð£',
        'ð¤',
        'ð¥',
        'ð¦',
        'ð§',
        'ð¨',
        'ð©',
        'ðª',
        'ð«',
        'ð¬',
        'ð­',
        'ð®',
        'ð¯',
        'ð°',
        'ð±',
        'ð²',
        'ð³',
      ]

      const bold_numbers = ['ðŸŽ', 'ðŸ', 'ðŸ', 'ðŸ‘', 'ðŸ’', 'ðŸ“', 'ðŸ”', 'ðŸ•', 'ðŸ–', 'ðŸ—']

      function render() {
        repaired.value = src.value
        repaired.value = repaired.value.replaceAll('\u00A0', ' ')
        repaired.value = repaired.value.replaceAll('\u2002', ' ')
        repaired.value = repaired.value.replaceAll('\u2003', ' ')
        repaired.value = repaired.value.replaceAll('á…Ÿ', ' ')

        bold_letters.forEach((l, i) => {
          repaired.value = repaired.value.replaceAll(l, letters[i])
        })

        repaired.value = repaired.value.replaceAll(/^ *[\d]+ \| /gm, '')

        watermarked.value = repaired.value

        // Replace tabs with spaces
        if (spaces.checked)
          watermarked.value = watermarked.value.replaceAll('\t', '    ')

        // Replace 4-space indents with alternate whitespace:
        // U+00A0 NO-BREAK SPACE
        // U+2002 EN SPACE
        // U+2003 EM SPACE
        if (whitespace.checked)
          watermarked.value = watermarked.value.replaceAll(
            '    ',
            '\u00A0 \u2002\u2003',
          )

        // Add an invisible Hangul Choseong Filler at the end of strings
        if (strings.checked)
          watermarked.value = watermarked.value.replaceAll('"', '"á…Ÿ')

        // Bold certain keywords using unicode math characters
        if (bold.checked) {
          keywords.forEach(kw => {
            bolded = Array.from(kw)
              .map(l => bold_letters[letters.indexOf(l)])
              .join('')
            watermarked.value = watermarked.value.replaceAll(
              new RegExp(`(^|\\W)(${kw})(\\W|$)`, 'g'),
              `$1${bolded}$3`,
            )
          })
        }

        if (linenums.checked) {
          watermarked.value = watermarked.value
            .split('\n')
            .map((l, i) => `${String(i + 1).padStart(3)} | ${l}`)
            .join('\n')
        }
      }

      src.addEventListener('input', render)
      document
        .querySelectorAll('input')
        .forEach(e => e.addEventListener('input', render))
      render()
    </script>
  </body>
</html>
